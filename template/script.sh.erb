#!/usr/bin/env bash

# Benchmark info
echo "-- TIMING - Starting main script at: $(date)"

workdir="/scratch_space/$USER/sprocket"
configfile="$(pwd)/sprocket.toml"

# Set working directory to home directory
mkdir -p ${workdir}
cd ${workdir}

#
# Start WDL Pipeline
#

<%- unless context.modules.blank? -%>
# Purge the module environment to avoid conflicts
module purge

# Load the require modules
module load <%= context.modules %>

# List loaded modules
module list
<%- end -%>

# Benchmark info
echo "-- TIMING - Starting \`<%= context.workflow %>\` at: $(date)"

# Debug output
#set -x

# Run sprocket
sprocket -v \
  <%- unless context.config.blank? -%>-c <%= context.config %><%- end -%> \
  -c "$configfile" \
  run \
  <%- unless context.entrypoint.blank? -%>--entrypoint <%= context.entrypoint %><%- end -%> \
  <%= context.workflow %> \
  <%= context.inputs %>
