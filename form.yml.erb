# Batch Connect app configuration file

<%-
  cpu_queues = OodAppkit.clusters[:hpc].custom_config[:cpu_queues]
-%>
---

# **MUST** set cluster id here that matches cluster configuration file located
# under /etc/ood/config/clusters.d/*.yml
cluster: hpc

attributes:
  modules: "sprocket/0.17.1+520"

  queue: 
    widget: select
    required: true
    label: Queue
    help: Please select a jobs queue for running WDL tasks.
    options:
    <%- cpu_queues.each do |q| -%>
      - [ "<%= q %>", "<%= q %>", data-set-gpu-job: 'false', data-hide-num-gpus: true, data-hide-gpu-type: true ]
    <%- end -%>
  
  # This is the number of cores and memory to give sprocket itself
  # The WDL workflow will determine the cpu/memory given to subjobs.
  num_cores: 1
  mem_size: 2048

  ################
  # App Specific #
  ################
  workflow:
    label: WDL Workflow File
    help: Select your WDL workflow (this may be a URL).
    data-filepicker: true
    data-target-file-type: files
    readonly: false
    required: true
    placeholder: "<path or URL to workflow>"

  inputs:
    label: WDL Workflow Inputs
    help: Inputs can be either paths to JSON or YAML files containing inputs or key-value pairs passed in on the command line to Sprocket.
    data-filepicker: true
    data-target-file-type: files
    readonly: false
    placeholder: "<path to inputs>"

  entrypoint:
    label: Entrypoint
    help: The name of WDL workflow or task to run; required if `inputs` is empty.
    placeholder: "<name of workflow>"

  config:
    label: Sprocket Configuration File
    help: Select your custom Sprocket configuration file (leave blank to use the default).
    data-filepicker: true
    data-target-file-type: files
    readonly: false
    placeholder: "<path to config>"

  max_scatter_concurrency:
    label: Max Scatter Concurrency
    help: |
      The maximum number of subtasks each `scatter` will try executing at once. This is *not* a direct
      limit on the total number of concurrent tasks, but can affect the number of jobs that get queued
      at one time.
    widget: number_field
    value: 100
    min: 1
    max: 1000

  apptainer_images_dir:
    label: Apptainer Images Cache
    value: "~/.cache/sprocket-apptainer-images"
    help: |
      The directory where container `.sif` images will be cached (leave blank to use the default).
      Be sure to regularly clear this directory out.
    data-filepicker: true
    data-target-file-type: dirs
    readonly: false
    placeholder: "<path to cache directory>"

  bc_num_hours:
    help: The maximum number of hours the submitted batch job may run.

form:
  - modules
  - queue
  - workflow
  - inputs
  - entrypoint
  # Uncomment when https://github.com/stjude-rust-labs/sprocket/pull/383 is merged and `sprocket` updated
  # - config
  - max_scatter_concurrency
  - apptainer_images_dir
  - num_cores
  - mem_size
  - bc_num_hours
  - bc_email_on_started
